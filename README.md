# **Reward-api**
 
API для сервиса начисления наград пользователям

---

## **Содержание**
1. [Описание проекта](#описание-проекта)
2. [Установка зависимостей](#установка-зависимостей)
3. [Запуск Docker-контейнеров](#запуск-docker-контейнеров)
4. [Применение миграций](#применение-миграций)
5. [Запуск тестов](#запуск-тестов)
6. [Примечания](#примечания)

---

## **Описание проекта**

Проект разработан для выполнения тестового задания на позицию python backend-разработчик.

ТЗ кратко:
>реализовать backend-приложение для управления пользователями, начислением наград и отложенными задачами.

Проект протестирован на debian 12 и centos 10.

Технологии:
- **Backend**: Django + Django REST Framework
- **База данных**: PostgreSQL
- **Фоновые задачи**: Celery + Redis
- **Контейнеризация**: Docker + docker-compose 
- **Аутентификация**: JWT
- **Документация API**: Swagger

---

## **Установка зависимостей**

Так как проект запускается в контейнерах, то для запуска нужен docker и docker-compose.

Для начала клонируйте репозиторий:

```bash
git clone https://github.com/lyintCode/reward-api.git

```

Далее либо запустите ./scripts/docker-compose-autoinstall.sh (Debian/Ubuntu | CentOS/RHEL/Fedora), либо установите docker и docker-compose вручную,
согласно инструкциям с оффициальных сайтов.

```bash
chmod +x ./scripts/docker-compose-autoinstall.sh
./scripts/docker-compose-autoinstall.sh
```

Если установка docker происходит впервые, то необходимо добавить пользователя в группу `docker` и перезапустить терминал
 (или прописать команду newgrp)
```bash
sudo usermod -aG docker $USER

# Для запуска новой оболочки с измененной основной группой
newgrp docker
```

Скрипт `docker-compose-autoinstall.sh` установит все зависимости автоматически.

## **Запуск Docker-контейнеров**

Для начала необходимо создать и заполнить .env файл в корне проекта  
Пример .env файла можно посмотреть в .env.example

Так как это тестовый проект, я заполнил .env.example стандартными данными

Так что для работы приложения достаточно скопировать .env

```bash
# В install.sh .env уже скопирован
cp .env.example .env
```

Далее разворачиваем контейнеры

```bash
# Запуск в терминале
docker-compose up --build

# ИЛИ запуск в режиме демона
docker-compose up -d --build

# Команда для остановки контейнеров
docker-compose down
```

После успешного развертывания всех контейнеров, протестировать приложение можно по адресу

http://localhost:8000/swagger/

или

запустить автоматический скрипт
```bash
chmod +x ./scripts/demo.sh
./scripts/demo.sh
```

Скрипт *demo.sh* использует curl что бы полностью проверить работу приложения

Пример вывода скрипта demo.sh  
```bash
╰─$ ./scripts/demo.sh
=== Демонстрация работы API ===
1. Регистрация нового пользователя...
Ответ на регистрацию: {"message":"Пользователь успешно зарегистрирован."}

2. Авторизация пользователя...
Ответ на авторизацию: {"refresh":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

3. Получение профиля пользователя...
Ответ на запрос профиля: {"username":"testuser","email":"test@somesite.ru","coins":200}

4. Запрос награды...
Ответ на запрос награды: {"non_field_errors":["Вы уже запросили награду сегодня. Попробуйте завтра."]}

5. Просмотр списка наград...
Ответ на запрос списка наград: [{"amount":100,"given_at":"2025-04-12T01:20:56.243187+03:00"},{"amount":100,"given_at":"2025-04-12T03:23:11.090338+03:00"}]

6. Обновление токена...
Ответ на обновление токена: {"access":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Новый токен доступа: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Новый токен отличается от старого. Обновление токена работает корректно.

7. Проверка нового токена (получение профиля)...
Ответ на запрос профиля с новым токеном: {"username":"testuser","email":"test@somesite.ru","coins":200}

=== Демонстрация завершена ===
```

Создание администратора и вход в админку
```bash
# Входим в контейнер
docker-compose exec api bash

# Создаем админа
DJANGO_SETTINGS_MODULE="core.settings.prod" python manage.py createsuperuser

# Выход из контейнера
exit
```

Адрес админки `http://localhost:8000/admin/`

## **Применение миграций**
Миграции применяются автоматически при запуске в контейнере внутри файла scripts/api_entrypoint.sh

## **Запуск тестов**
Для запуска тестов необходимо развернуть виртуальное окружение

```bash
# Должен быть установлен пакет python3-venv
python3 -m venv .venv
source .venv/bin/activate

# Устанавливаем зависимости
pip install --upgrade pip
pip install -r requirements.txt
```

Запуск тестов
```bash
# Так как настройки разделенные, то необходимо указать dev настройки

# Запуск всех тестов разом
DJANGO_SETTINGS_MODULE="core.settings.dev" python manage.py test

# Запуск тестов отдельно каждого приложения
DJANGO_SETTINGS_MODULE="core.settings.dev" python manage.py test authentication
DJANGO_SETTINGS_MODULE="core.settings.dev" python manage.py test rewards
DJANGO_SETTINGS_MODULE="core.settings.dev" python manage.py test users
```

## **Примечания**
1. В ТЗ не указано использования какого либо фронтенд фреймворка, поэтому по умолчанию ничего не использую.
Протестировать работу можно либо в swagger, либо через demo.sh

2. Так как в ТЗ нет слов про разворачивание nginx или любого другого веб-сервера, приложение запускаю через встроенный
веб сервер django, что бы статика отображалась правильно. По этому причине не использую wsgi сервер (gunicorn) и оставляю
debug=True, иначе статика отображаться не будет.

3. В этом тестовом проекте не сильно озаботился безопасностью (не разделял .env файлы, оставил debug и прочее по мелочи)
потому как цель этого проекта выполнения тестового задания, а не разработка полноценного бэкенда
